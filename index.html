<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Progress Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="loading-spinner" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>
    
    <div id="app-container" class="w-full max-w-4xl mx-auto hidden">
        <div class="bg-gray-800 rounded-2xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <button id="prev-month" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 id="current-month-year" class="text-2xl font-bold"></h2>
                <button id="next-month" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <div class="grid calendar-grid gap-2 text-center text-sm font-medium text-gray-400 mb-2">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>

            <div id="calendar-body" class="grid calendar-grid gap-2">
                <!-- Calendar days will be generated here by JS -->
            </div>

            <div class="mt-6 flex justify-center items-center space-x-4 text-sm">
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span>Completed</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-500 mr-2"></span>Rest Day</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-500 mr-2"></span>Missed</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-gray-700 mr-2"></span>Unmarked</div>
            </div>

             <div class="mt-6 text-center text-gray-500 text-xs">
                Your User ID: <span id="user-id" class="font-mono"></span>
             </div>
        </div>
    </div>

    <!-- Modal for updating status -->
    <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-gray-800 rounded-2xl shadow-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold text-center mb-6" id="modal-date">Update Status</h3>
            <div class="space-y-3">
                <button data-status="Completed" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">Completed Workout</button>
                <button data-status="Rest Day" class="w-full text-white bg-yellow-500 hover:bg-yellow-600 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">Rest Day</button>
                <button data-status="Missed" class="w-full text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">Missed Workout</button>
                <button data-status="Unmarked" class="w-full text-gray-300 bg-gray-700 hover:bg-gray-600 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">Clear Status</button>
            </div>
             <button id="close-modal" class="mt-6 w-full text-gray-400 hover:text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center">Cancel</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config and Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM Elements ---
        const calendarBody = document.getElementById('calendar-body');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const modal = document.getElementById('status-modal');
        const modalDateEl = document.getElementById('modal-date');
        const closeModalBtn = document.getElementById('close-modal');
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContainer = document.getElementById('app-container');
        const userIdEl = document.getElementById('user-id');
        
        // --- State ---
        let currentDate = new Date();
        let currentUserId = null;
        let progressData = {};
        let unsubscribe; // To store the onSnapshot listener

        // --- Authentication ---
        async function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdEl.textContent = currentUserId;
                    await renderCalendar();
                    loadingSpinner.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                } else {
                    try {
                        await setPersistence(auth, browserLocalPersistence);
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                    }
                }
            });
        }
        
        // --- Firestore ---
        function getProgressCollectionRef() {
            if (!currentUserId) return null;
            return collection(db, `artifacts/${appId}/users/${currentUserId}/progress`);
        }

        async function saveProgress(dateStr, status) {
            if (!currentUserId) {
                console.error("No user logged in to save progress.");
                return;
            }
            try {
                const docRef = doc(getProgressCollectionRef(), dateStr);
                const data = { status: status };
                await setDoc(docRef, data);
            } catch (error) {
                console.error("Error saving progress: ", error);
            }
        }
        
        function fetchAndListenForProgress() {
            if (unsubscribe) {
                unsubscribe(); // Detach the old listener
            }
            const colRef = getProgressCollectionRef();
            if (!colRef) return;
            
            const q = query(colRef);
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                progressData = {};
                querySnapshot.forEach((doc) => {
                    progressData[doc.id] = doc.data().status;
                });
                // Re-render the calendar with the new data
                renderCalendarUI();
            }, (error) => {
                console.error("Error fetching progress:", error);
            });
        }

        // --- Calendar Logic ---
        function getStatusColorClass(status) {
            switch (status) {
                case 'Completed': return 'bg-green-500 hover:bg-green-600';
                case 'Rest Day': return 'bg-yellow-500 hover:bg-yellow-600';
                case 'Missed': return 'bg-red-500 hover:bg-red-600';
                default: return 'bg-gray-700 hover:bg-gray-600';
            }
        }
        
        function renderCalendarUI() {
            calendarBody.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const monthName = currentDate.toLocaleString('default', { month: 'long' });
            currentMonthYearEl.textContent = `${monthName} ${year}`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Create blank days for the start of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarBody.innerHTML += `<div class="p-2 rounded-lg"></div>`;
            }

            // Create days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const status = progressData[dateStr] || 'Unmarked';
                const colorClass = getStatusColorClass(status);
                
                const today = new Date();
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                const todayClass = isToday ? 'ring-2 ring-blue-500' : '';

                const dayEl = document.createElement('div');
                dayEl.className = `day-cell p-2 h-16 rounded-lg flex items-center justify-center cursor-pointer transition-all duration-200 ${colorClass} ${todayClass}`;
                dayEl.textContent = day;
                dayEl.dataset.date = dateStr;
                calendarBody.appendChild(dayEl);
            }
        }
        
        async function renderCalendar() {
             if (!currentUserId) return;
             // Detach old listener, fetch new data, and then render UI
             fetchAndListenForProgress();
             renderCalendarUI(); // Initial render while data is fetching
        }

        // --- Event Listeners ---
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        let selectedDate = null;
        calendarBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('day-cell')) {
                selectedDate = e.target.dataset.date;
                const dateObj = new Date(selectedDate + 'T00:00:00');
                modalDateEl.textContent = `Update: ${dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`;
                modal.classList.remove('hidden');
            }
        });

        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
        
        modal.addEventListener('click', (e) => {
             // Close modal if clicking outside the content
            if(e.target === modal){
                 modal.classList.add('hidden');
            }
        });

        modal.querySelectorAll('[data-status]').forEach(button => {
            button.addEventListener('click', () => {
                if (selectedDate) {
                    const status = button.dataset.status;
                    saveProgress(selectedDate, status);
                }
                modal.classList.add('hidden');
            });
        });

        // --- App Initialization ---
        setupAuth();

    </script>
</body>
</html>
